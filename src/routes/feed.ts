// src/routes/feed.ts

import { Router, Request, Response } from 'express';
// âœ… Shtuar .js pÃ«r shkak tÃ« konfigurimit NodeNext
import { supabase, AdCampaign } from '../services/supabaseClient.js'; 
import { checkCache, saveCache } from '../services/cacheService.js'; 

const feedRouter = Router();

// Krijon njÃ« Ã§elÃ«s tÃ« qÃ«ndrueshÃ«m cache-i
const FEED_CACHE_KEY = 'global_active_feed';
// Koha e vlefshmÃ«risÃ« sÃ« cache-it (p.sh., 5 minuta)
const CACHE_TTL_SECONDS = 300; 

// ----------------------------------------------------------------------------------
// ENDPOINT: GET /api/feed-posts?limit=X
// Ky merr postimet (reklamat aktive) nga Supabase.
// ----------------------------------------------------------------------------------
feedRouter.get('/feed-posts', async (req: Request, res: Response) => {
    const limit = parseInt(req.query.limit as string) || 20;
    
    // 1. Kontrollon Cache-in
    const cachedData = await checkCache(FEED_CACHE_KEY); 
    if (cachedData) {
        // ShÃ«rbe nga Cache-i dhe kthen vetÃ«m numrin e kÃ«rkuar
        console.log('âœ… Feed u shÃ«rbye nga Cache.');
        const posts = cachedData as AdCampaign[];
        return res.json(posts.slice(0, limit));
    }

    try {
        // 2. Merr Reklamat nga Supabase
        const { data: campaigns, error } = await supabase
            .from('ad_campaigns')
            .select(`
                id,
                user_id,
                title,
                image_url,
                description,
                views_purchased,
                views_delivered,
                status 
            `)
            .eq('status', 'active') // Merr vetÃ«m fushat aktive
            .gt('views_purchased', 'views_delivered') // Merr vetÃ«m ato me kuotÃ« tÃ« mbetur
            .order('id', { ascending: true }) // Renditja e thjeshtÃ«
            .limit(200); // Merr njÃ« sasi tÃ« mjaftueshme pÃ«r cache

        if (error) {
            console.error('Gabim nÃ« marrjen e fushatave:', error);
            return res.status(500).json({ error: 'DÃ«shtim nÃ« bazÃ«n e tÃ« dhÃ«nave.' });
        }

        // PÃ«rgatit tÃ« dhÃ«nat e thjeshtÃ«zuara pÃ«r Frontend-in
        const feedPosts = campaigns.map(campaign => ({
            id: campaign.id,
            title: campaign.title,
            description: campaign.description,
            imageUrl: campaign.image_url,
            // Shtoni Ã§do meta-tÃ« dhÃ«nÃ« qÃ« i nevojitet Front-endit (p.sh., linku)
        }));

        // 3. Ruaj nÃ« Cache
        await saveCache(FEED_CACHE_KEY, feedPosts, CACHE_TTL_SECONDS);
        console.log(`ğŸ’¾ Feed i ruajtur nÃ« Cache pÃ«r ${CACHE_TTL_SECONDS} sekonda.`);
        
        // 4. Kthe rezultatin (vetÃ«m numrin e kÃ«rkuar)
        return res.json(feedPosts.slice(0, limit));

    } catch (error) {
        console.error('Gabim nÃ« /api/feed-posts:', error);
        return res.status(500).json({ error: 'Internal Server Error' });
    }
});

export default feedRouter;
